define(["directives/directives","moment"],function(e,t){e.directive("directPostDetails",["$compile","deploydService","$cookies","authServices","$rootScope",function(e,n,r,i,s){function o(e,r,o){function u(e,t){n.CreateComment(e,"comment",function(e){e.id!=undefined?(r.find("input#chkNickname").removeClass("checked"),r.find(".inputNickname").val(""),r.find("#comment").val(""),a()):alert("failed to comment, please try again or contact admin.")})}function a(){n.GetCommentbyPostid(e.postid,"comment",function(t){e.commentdb=t,e.commentedCount=t.length,e.commentdb.length-e.commentLimit>3?(e.remainLength=e.commentdb.length-e.commentLimit,e.displayAllComment=!0):(e.displayAllComment=!1,e.commentdb.length>3?e.displayReadmore=!0:e.displayReadmore=!1)})}function c(t){var n=["liked","disliked","shited","loved"],r=["isLiked","isDisliked","isShited","isLoved"];for(var i=0;i<n.length;i++)e.thisPost[r[i]]=!1,t[n[i]].forEach(function(t){t==e.username&&(e.thisPost[r[i]]=!0)})}e.commentSubmit=function(){var t=r.find("#comment").val();if(t==""){r.find("#comment").parent().find(".help-block").html("Please enter your comment.").css("color","red");return}if(t.length<2){r.find("#comment").parent().find(".help-block").html("Comment must more than 2 character.").css("color","red");return}r.find("#comment").parent().find(".help-block").html(""),i.GetCurrentUser(function(n){if(n.displayname!=undefined){var i=r.find(".inputNickname").val();if(i=="")nickname=n.displayname,usenick=!1;else{if(i.length<3){r.find(".inputNickname").parent().parent().find(".help-block-input").html("Nickname must more than 3 character.").css("color","red");return}nickname=i,usenick=!0}var s={};s.postid=e.postid,s.displayname=nickname,s.username=n.username,s.date=new Date,s.content=t,s.categories=e.postType,s.usenick=usenick,s.isfb=n.role=="FB"?!0:!1,u(s,function(e){alert("successful commeted")})}else{var i=r.find(".inputNickname").val(),s={};if(i=="")s.displayname="anonymous",s.username="anonymous";else{if(i.length<3){r.find(".inputNickname").parent().parent().find(".help-block-input").html("Nickname must more than 3 character.").css("color","red");return}s.displayname=i,s.username="anonymous"}s.postid=e.postid,s.date=new Date,s.content=t,s.categories=e.postType,s.usenick=!0,s.isfb=!1,u(s,function(e){alert("successful commeted")})}r.find(".inputNickname").parent().parent().find(".help-block-input").html("")})},$(r).ready(function(){s.$on("openPost",function(t){content=s.contentDetails,r.modal("show"),$("#overlay").show(),r.find("#loading-indicator").show(),i.GetCurrentUser(function(t){t==-1?e.currDisplayname="anonymous":t.displayname!=undefined&&(e.currDisplayname=t.displayname),n.GetPostbyPostid(content.id,content.postType,function(t){e.postid=t.id,e.postTitle=t.title,e.postContent=t.content,e.postDate=e.formatFromTodayDate(t.date),e.postBy=t.displayname,e.liked=t.liked.length,e.disliked=t.disliked.length,e.shited=t.shited.length,e.loved=t.loved.length,e.postType=content.postType,e.commentedCount=t.commentedCount,e.usenick=t.usenick,e.isfb=t.isfb,e.username=t.username,$("#overlay").hide(),r.find("#loading-indicator").hide(),e.thisPost=angular.copy(t),c(e.thisPost)})})}),r.find("#comment").autoGrow({extraLine:!0}),$("#my_postDetails_Modal").on("hidden.bs.modal",function(){$(this).data("bs.modal",null),r.find("#collapseComment").collapse("hide"),r.find(".inputNickname").parent().parent().find(".help-block-input").html(""),r.find(".inputNickname").val(""),r.find("#comment").val(""),e.commentdb=[],e.hasDeleted=!1,e.commentDeleted=undefined}),e.readMoreComment=function(){n.GetCommentbyPostid(e.postid,"comment",function(t){e.commentdb=t;var n=e.commentdb.length-e.commentLimit;e.commentLimit<e.commentdb.length&&(n>=3?e.commentLimit+=3:e.commentLimit+=n,n>=3?e.remainLength-=3:e.remainLength-=n,e.remainLength>3?e.displayAllComment=!0:e.displayAllComment=!1,e.displayCollapsebtn=!0),e.commentdb.length>e.commentLimit?e.displayReadmore=!0:e.displayReadmore=!1})},e.readAllComment=function(){n.GetCommentbyPostid(e.postid,"comment",function(t){e.commentLimit=t.length,e.remainLength=0,e.displayAllComment=!1,e.displayReadmore=!1,e.displayCollapsebtn=!0})},e.refreshAllComment=function(){e.hasDeleted=!1,e.commentDeleted=undefined,n.GetCommentbyPostid(e.postid,"comment",function(t){e.commentdb=t,e.commentLimit=3,e.displayCollapsebtn=!1;if(e.commentdb.length==e.commentLimit)return;var n=e.commentdb.length-e.commentLimit;n>3?e.displayAllComment=!0:e.displayAllComment=!1,e.commentdb.length-e.commentLimit>3?e.remainLength=e.commentdb.length-3:e.remainLength=e.commentdb.length,e.commentdb.length>e.commentLimit?e.displayReadmore=!0:e.displayReadmore=!1})},e.collapseAllComment=function(){e.commentLimit=3,e.displayCollapsebtn=!1,e.commentdb.length>e.commentLimit?e.displayReadmore=!0:e.displayReadmore=!1,e.commentdb.length-e.commentLimit>3?e.displayAllComment=!0:e.displayAllComment=!1,e.commentdb.length-e.commentLimit>3?e.remainLength=e.commentdb.length-3:""},e.deleteComment=function(t){e.hasDeleted=!1,e.currentCommentTarget=this.comment;if(e.currentCommentTarget.username!=e.commentUser.username&&e.commentUser.role!="admin")alert("ops, something wrong, if this comment belong to your, please report to admin!");else{var r={id:e.currentCommentTarget.id,status:"D",updatedby:e.commentUser,lastdate:new Date};n.DeleteComment(r,function(t){t.status=="D"&&(alert("your comment has been deleted."),e.currentCommentTarget.status=t.status,e.commentedCount--,e.commentDeleted=e.currentCommentTarget,e.hasDeleted=!0)})}},e.editComment=function(t){$(t.target).parent().parent().parent().find(".help-block").html(""),e.currentCommentTarget=this.comment,e.commentdb.forEach(function(t){t.isEdit==1&&(t.isEdit=!1,t.content=angular.copy(e.commentBackup.content))}),e.commentBackup=angular.copy(e.currentCommentTarget),e.currentCommentTarget.isEdit=!0,window.setTimeout(function(){r.find(".editComment").autoGrow({extraLine:!0})},0)},e.updateComment=function(t){e.currentCommentTarget=this.comment;var r=e.currentCommentTarget.content.trim(),s=$(t.target).parent().parent().parent();if(e.commentBackup.content===r){s.find(".help-block").html("Please modify your content.").css("color","red");return}if(r==""){s.find(".help-block").html("Please enter your comment.").css("color","red");return}if(r.length<2){s.find(".help-block").html("Comment must more than 2 character.").css("color","red");return}s.find(".help-block").html(""),i.GetCurrentUser(function(t){if(t==-1)alert("Login error, if saw this message, please report to admin.");else{var r=t.username,i={commentid:e.currentCommentTarget.id,username:r,content:e.commentBackup.content},s={commentid:e.currentCommentTarget.id,content:e.currentCommentTarget.content,updatedby:r,lastdate:new Date};n.AddCommentBackup(i,"backupcomment",function(t){t.id!=undefined?n.UpdateComment(s,function(t){t.id!=undefined?(alert("Post updated."),e.refreshAllComment()):(alert("Something wrong, please report to admin with code x00979."),e.currentCommentTarget.isEdit=!1)}):(alert("Something wrong, please report to admin with code x00978."),e.currentCommentTarget.isEdit=!1)})}})},e.commentCancel=function(t){e.currentCommentTarget=this.comment,e.currentCommentTarget.isEdit=!1,$(t.target).parent().parent().parent().find(".help-block").html(""),e.commentBackup.id==e.currentCommentTarget.id?e.currentCommentTarget.content=angular.copy(e.commentBackup.content):console.debug("Invalid Backup ID")},e.undoDeleted=function(){var t={id:e.commentDeleted.id,status:"A",updatedby:e.commentUser};n.DeleteComment(t,function(t){t.status=="A"&&(alert("your comment has been UNDO."),e.commentDeleted.status=t.status,e.commentedCount++,e.hasDeleted=!1,e.commentDeleted=undefined)})},r.find("#collapseComment").on("show.bs.collapse",function(){e.commentLimit=3,$("#overlay").show(),e.hasDeleted=!1,e.commentDeleted=undefined,i.GetCurrentUser(function(t){t==-1?e.currLoginName="anonymous":t.displayname!=undefined&&(e.currLoginName=t.displayname,e.commentUser=t)}),r.find("#loading-indicator").show(),n.GetCommentbyPostid(e.postid,"comment",function(t){e.commentdb=t,e.displayCollapsebtn=!1,e.displayRefreshbtn=!0,e.commentdb.length>3?e.remainLength=e.commentdb.length-3:e.remainLength=e.commentdb.length,e.commentdb.length>3?e.displayReadmore=!0:e.displayReadmore=!1,e.remainLength>3?e.displayAllComment=!0:e.displayAllComment=!1,r.find("#loading-indicator").hide(),$("#overlay").hide()})});var t=!1;e.actionClicked=function(r,i,s){if(!t){t=!0,e.thisPost[i]?e.thisPost[r].splice(e.thisPost[r].indexOf(e.username)):e.thisPost[r].push(e.username);var o={};o.id=e.thisPost.id,o[r]=e.thisPost[r],n.UpdatePostAction(o,r,e.postType,function(n){e[r]=n[r].length,e.thisPost[i]=!e.thisPost[i],t=!1})}}});var f=t().endOf("day"),l=t().startOf("day");e.formatFromTodayDate=function(e){return t(e)>=l&&t(e)<=f?t(e).fromNow():t(e).format("DD-MM-YYYY, h:mm a")}}return{restrict:"E",template:'<div class="modal fade" id="my_postDetails_Modal" role="dialog"><div class="modal-dialog"><!-- Modal content--><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal">&times;</button><h4 class="modal-title">{{postTitle}}</h4><span ng-if="usenick == false && isfb == true"><small class="text-muted"> {{postDate}} was posted by <a href="http://www.facebook.com/{{username}}" target="_blank"  style="color:#a8168f">{{postBy}}</a></small></span><span ng-if="usenick == true || isfb == false"><small class="text-muted"> {{postDate}} was posted by {{postBy}}</small></span><i class="fa fa-star-o" aria-hidden="true" style="color:red" ng-if="usenick == true" data-toggle="tooltip" data-placement="bottom" title="This star mean the author use custom nickname to post."></i></small></div><img src="img/loading.gif" id="loading-indicator" style="display:none" /><form role="form"><div class="form-group"><p style="max-height: 250px;min-height: 100px;background: aquamarine;padding-left: 10px;padding-top: 10px;overflow: auto;" ng-bind-html = "postContent | newLine" ng-model="postContent">{{postContent}}</p></div><div class="form-group"><span><a class="btnLike actionBtn" ng-click="actionClicked(\'liked\',\'isLiked\',$event)" >&#128077; {{liked}} <span ng-if="!thisPost.isLiked">Like</span> <span ng-if="thisPost.isLiked">Liked</span> </a> </span><span><a class="btnDislike actionBtn" ng-click="actionClicked(\'disliked\',\'isDisliked\',$event)">&#128078; {{disliked}} <span ng-if="!thisPost.isDisliked">Dislike</span> <span ng-if="thisPost.isDisliked">Disliked</span></a> </span><span><a class="btnShit actionBtn" style="color: brown;" ng-click="actionClicked(\'shited\',\'isShited\',$event)">&#128169; {{shited}} <span ng-if="!thisPost.isShited">Shit</span> <span ng-if="thisPost.isShited">Shited</span></a></span><span><a class="btnLove actionBtn" style="color:red;" ng-click="actionClicked(\'loved\',\'isLoved\',$event)">&#x2764; {{loved}} <span ng-if="!thisPost.isLoved">Love</span> <span ng-if="thisPost.isLoved">Loved</span></a> </span> <span><a class="btnComment actionBtn" style="color:#4acdea;" data-toggle="collapse" href="#collapseComment" >&#128172; {{commentedCount}} Comment </a> </span> </div><div class="collapse" id="collapseComment"><div class="container"><img src="img/loading.gif" id="loading-indicator" style="display:none" /><div class="row"><a ng-click="readMoreComment()" ng-if="displayReadmore" href=""><small class="text-muted">Read more</small></a><a ng-click="readAllComment()" ng-if="displayAllComment" href="" style="margin-left: 10px;"><small class="text-muted">Read previous {{remainLength}} comment</small></a><a ng-click="collapseAllComment()" ng-if="displayCollapsebtn" href="" style="margin-left: 10px;"><small class="text-muted">collapse</small></a><a ng-click="refreshAllComment()" ng-if="displayRefreshbtn" href="" style="margin-left: 10px;"><small class="text-muted">Refresh comment</small></a><a ng-click="undoDeleted()" ng-if="hasDeleted" href=""><small class="text-muted" style="display:block;color:blue">Undo</small></a><div ng-repeat="comment in commentdb | limitTo:commentLimit | orderBy:\'date\'" ng-if="comment.status == \'A\'" class="col-sm-12" style="border-bottom: 1px solid #ebebeb;min-height: 50px;text-align: left;"><div ng-if="comment.username != \'anonymous\' && commentUser.username == comment.username || commentUser.role == \'admin\'" style="float: right;position: relative;"><a href="" style="color:#c53232" class="dropdown-toggle glyphicon glyphicon-menu-down btn-lg" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></a><div class="dropdown-menu" aria-labelledby="dpCategories" style="min-width:90px;max-width:90px"><a class="dropdown-item" ng-click="editComment($event)">Edit</a><a class="dropdown-item deleteBtn"  ng-click="deleteComment()" >Delete</a></div></div><div><strong style="color:blue;display:inline-block"> {{comment.displayname}}</strong> : <div ng-if="!comment.isEdit" style="display:inline-block">{{comment.content}}</div><div class="help-block" style="display:inline-block"></div><textarea row="1" class="form-control txtComment overflowauto editComment" ng-if="comment.isEdit" maxlength="500" style="display:block;max-height: 400px;min-height: 100px;background: #fafffd;padding-left: 10px;padding-top: 10px;overflow: auto;" ng-bind-html = "comment.content | newLine" ng-model="comment.content"></textarea><div style="float:right" ng-if="comment.isEdit"><small class="text-muted"><a href="#" style="margin-right:3px" ng-click="updateComment($event)">Upate</a><a href="#" ng-click="commentCancel($event)">Cancel</a></small></div><div><small class="text-muted">{{formatFromTodayDate(comment.date)}}</small></div></div></div></div></div><form role="form"><div style="margin-left:10px;color:red" ng-if="currDisplayname == \'anonymous\' && !( postType == \'public\' )" >Please login to comment</div><div class="form-group card-block card" ng-if="(postType != \'public\' && currDisplayname != \'anonymous\') || ( postType == \'public\' )"><textarea class="form-control" rows="3" id="comment" placeholder="Enter comment" ></textarea><div class="help-block with-errors"></div><div class="form-group"><div class="input-group"><span class="input-group-addon"><h6>Comment by : </h6></span><input type="text" class="form-control inputNickname" ng-model="inputText" placeholder="{{currLoginName}} (You may change this name if you wish to.)" maxlength="25" aria-label="Text input with checkbox" ng-disabled="isDisableInputNickname"></div><div class="help-block-input with-errors"></div></div><button class="btn btn-primary btnSubmit" type="submit" ng-click="commentSubmit()">Submit</button></div></form></div></form></div></div></div>',link:o,replace:!0}}])});